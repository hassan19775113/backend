name: Agent Engine

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:

  auth-validator:
    uses: ./.github/workflows/backend-setup.yml
    with:
      agent_command: node scripts/agents/auth-validator.js > agent-outputs/auth-validator.json
      upload_artifact_name: auth-validator-output
      upload_artifact_path: agent-outputs/auth-validator.json

  seed-orchestrator:
    needs: auth-validator
    uses: ./.github/workflows/backend-setup.yml
    with:
      agent_command: node scripts/agents/seed-orchestrator.js > agent-outputs/seed-orchestrator.json
      upload_artifact_name: seed-orchestrator-output
      upload_artifact_path: agent-outputs/seed-orchestrator.json

  page-smoke:
    needs: seed-orchestrator
    uses: ./.github/workflows/backend-setup.yml
    with:
      agent_command: node scripts/agents/page-smoke.js > agent-outputs/page-smoke.json
      upload_artifact_name: page-smoke-output
      upload_artifact_path: agent-outputs/page-smoke.json

  e2e-tests:
    needs: page-smoke
    uses: ./.github/workflows/backend-setup.yml
    with:
      agent_command: |
        mkdir -p logs
        npx playwright test 2>&1 | tee logs/playwright.log
      upload_artifact_name: test-results
      upload_artifact_path: logs/playwright.log

  flaky-classifier:
    needs: e2e-tests
    uses: ./.github/workflows/backend-setup.yml
    with:
      agent_command: node scripts/agents/flaky-classifier.js > agent-outputs/flaky-classifier.json
      upload_artifact_name: flaky-classifier-output
      upload_artifact_path: agent-outputs/flaky-classifier.json

  selector-auditor:
    needs: e2e-tests
    uses: ./.github/workflows/backend-setup.yml
    with:
      agent_command: node scripts/agents/selector-auditor.js > agent-outputs/selector-auditor.json
      upload_artifact_name: selector-auditor-output
      upload_artifact_path: agent-outputs/selector-auditor.json
