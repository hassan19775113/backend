name: Import Stabilization Backlog

run-name: Import Stabilization Backlog (dry_run=${{ inputs.dry_run }})

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "If true, only print what would be created/imported"
        type: boolean
        required: false
        default: true

permissions:
  contents: read
  issues: write

jobs:
  import:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: ${{ secrets.PROJECT_ID }}
      PROJECT_NUMBER: ${{ secrets.PROJECT_NUMBER }}
      PARENT_FIELD_ID: ${{ secrets.PARENT_FIELD_ID }}
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate issues.json from stabilization epics
        shell: bash
        run: |
          set -eo pipefail
          if [ -f docs/stabilization-epics.md ]; then
            echo "Generating automation/issues.json from docs/stabilization-epics.md"
            python3 scripts/stabilization_epics_to_issues.py docs/stabilization-epics.md automation/issues.json
          else
            echo "docs/stabilization-epics.md not found; using existing automation/issues.json"
          fi

      - name: Import Issues
        run: |
          set -eo pipefail
          echo "Starting issue import..."

          echo "Ensuring labels exist..."
          jq -r '.[].labels? // [] | .[]' automation/issues.json | sort -u | while IFS= read -r label; do
            [ -z "${label:-}" ] && continue
            if [ "${{ inputs.dry_run }}" = "true" ]; then
              echo "[DRY RUN] Would ensure label exists: $label"
              continue
            fi
            if ! gh label list --limit 200 --search "$label" --json name | jq -e --arg name "$label" '.[] | select(.name==$name)' > /dev/null; then
              echo "Creating missing label: $label"
              gh label create "$label" --color "ededed" --description "Imported by stabilization backlog workflow" || true
            fi
          done

          jq -c '.[]' automation/issues.json | while IFS= read -r issue; do
            TITLE=$(printf '%s' "$issue" | jq -r '.title')
            BODY=$(printf '%s' "$issue" | jq -r '.body')
            LABELS=$(printf '%s' "$issue" | jq -r '(.labels // []) | join(",")')

            # Check if issue already exists
            if gh issue list --search "$TITLE" --json title | jq -e --arg title "$TITLE" '.[] | select(.title==$title)' > /dev/null; then
              echo "Skipping existing issue: $TITLE"
              continue
            fi

            if [ "${{ inputs.dry_run }}" = "true" ]; then
              echo "[DRY RUN] Would create issue: $TITLE"
            else
              echo "Creating issue: $TITLE"
              if [ -n "${LABELS:-}" ]; then
                gh issue create \
                  --title "$TITLE" \
                  --body "$BODY" \
                  --label "$LABELS"
              else
                gh issue create \
                  --title "$TITLE" \
                  --body "$BODY"
              fi
            fi
          done

      - name: Import Project Structure (YAML)
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "[DRY RUN] Would import project YAML"
          else
            echo "Importing project YAML..."
            if [ -z "${GH_TOKEN:-}" ]; then
              echo "Skipping project import: missing repo secret IMPORT_GH_TOKEN (PAT/Fine-grained token with Projects access)."
              exit 0
            fi
            gh project item-import \
              --owner "${{ github.repository_owner }}" \
              --format yaml \
              --input automation/project-import.yml
          fi
        env:
          # NOTE: GitHub Actions permissions do not support `projects: write`.
          # For Projects v2 import, provide a PAT/Fine-grained token as a repo secret.
          GH_TOKEN: ${{ secrets.IMPORT_GH_TOKEN }}

