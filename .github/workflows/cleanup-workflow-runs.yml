name: Cleanup Workflow Runs

on:
  # Run weekly on Sundays at 00:00 UTC
  # Cron: minute hour day-of-month month day-of-week
  # Day 0 = Sunday (also could use 7)
  schedule:
    - cron: '0 0 * * 0'
  # Allow manual trigger
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      # Configurable retention settings
      RETENTION_DAYS: 30
      KEEP_RECENT_RUNS: 10
    
    steps:
      - name: Cleanup old workflow runs
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          set -e
          
          echo "Starting workflow runs cleanup..."
          echo "Repository: $REPO"
          echo "Retention period: $RETENTION_DAYS days"
          echo "Keeping recent runs: $KEEP_RECENT_RUNS"
          echo ""
          
          # Calculate cutoff date (RETENTION_DAYS ago)
          if [[ "$OSTYPE" == "darwin"* ]]; then
            # macOS
            CUTOFF_DATE=$(date -u -v-${RETENTION_DAYS}d +"%Y-%m-%dT%H:%M:%SZ")
            CUTOFF_TIMESTAMP=$(date -u -v-${RETENTION_DAYS}d +%s)
          else
            # Linux
            CUTOFF_DATE=$(date -u -d "${RETENTION_DAYS} days ago" +"%Y-%m-%dT%H:%M:%SZ")
            CUTOFF_TIMESTAMP=$(date -u -d "${RETENTION_DAYS} days ago" +%s)
          fi
          
          echo "Cutoff date: $CUTOFF_DATE"
          echo ""
          
          # Initialize counters
          total_deleted=0
          total_kept=0
          
          # Get list of all workflows
          workflows=$(gh api -X GET "/repos/$REPO/actions/workflows" --jq '.workflows[].id')
          
          echo "Processing workflows..."
          echo ""
          
          for workflow_id in $workflows; do
            # Get workflow name
            workflow_name=$(gh api -X GET "/repos/$REPO/actions/workflows/$workflow_id" --jq '.name')
            echo "Processing workflow: $workflow_name (ID: $workflow_id)"
            
            # Get all runs for this workflow (sorted by created date, newest first)
            runs=$(gh api -X GET "/repos/$REPO/actions/workflows/$workflow_id/runs?per_page=100" --paginate --jq '.workflow_runs[] | {id: .id, created_at: .created_at, name: .name, status: .status, conclusion: .conclusion}')
            
            # Track runs for this workflow
            workflow_deleted=0
            workflow_kept=0
            run_count=0
            
            # Process each run
            while IFS= read -r run; do
              if [ -z "$run" ]; then
                continue
              fi
              
              run_count=$((run_count + 1))
              run_id=$(echo "$run" | jq -r '.id')
              run_created=$(echo "$run" | jq -r '.created_at')
              run_status=$(echo "$run" | jq -r '.status')
              run_conclusion=$(echo "$run" | jq -r '.conclusion')
              
              # Keep the most recent N runs
              if [ $run_count -le $KEEP_RECENT_RUNS ]; then
                echo "  ✓ Keeping recent run #$run_count: ID $run_id (created: $run_created, status: $run_status)"
                workflow_kept=$((workflow_kept + 1))
                total_kept=$((total_kept + 1))
                continue
              fi
              
              # Delete runs older than cutoff date (using timestamp comparison for reliability)
              # Convert run creation date to timestamp
              if [[ "$OSTYPE" == "darwin"* ]]; then
                # macOS
                run_timestamp=$(date -u -j -f "%Y-%m-%dT%H:%M:%SZ" "$run_created" +%s 2>/dev/null || echo "0")
              else
                # Linux
                run_timestamp=$(date -u -d "$run_created" +%s 2>/dev/null || echo "0")
              fi
              
              if [ "$run_timestamp" != "0" ] && [ "$run_timestamp" -lt "$CUTOFF_TIMESTAMP" ]; then
                # Calculate actual age in days
                run_age_seconds=$(( $(date -u +%s) - run_timestamp ))
                run_age_days=$(( run_age_seconds / 86400 ))
                
                echo "  ✗ Deleting old run: ID $run_id (created: $run_created, age: $run_age_days days, status: $run_status, conclusion: $run_conclusion)"
                
                # Delete the run
                if gh api -X DELETE "/repos/$REPO/actions/runs/$run_id" 2>/dev/null; then
                  workflow_deleted=$((workflow_deleted + 1))
                  total_deleted=$((total_deleted + 1))
                  # Rate limiting: sleep briefly between deletions
                  sleep 0.5
                else
                  echo "    ⚠ Failed to delete run $run_id"
                fi
              else
                echo "  ✓ Keeping run: ID $run_id (created: $run_created, within retention period)"
                workflow_kept=$((workflow_kept + 1))
                total_kept=$((total_kept + 1))
              fi
            done <<< "$runs"
            
            echo "  Workflow summary: Deleted $workflow_deleted, Kept $workflow_kept"
            echo ""
          done
          
          # Final summary
          echo "═══════════════════════════════════════════════════════════"
          echo "Cleanup Summary"
          echo "═══════════════════════════════════════════════════════════"
          echo "Total runs deleted: $total_deleted"
          echo "Total runs kept: $total_kept"
          echo "Retention policy: Keep runs newer than $RETENTION_DAYS days"
          echo "Recent runs policy: Keep most recent $KEEP_RECENT_RUNS runs per workflow"
          echo "═══════════════════════════════════════════════════════════"
          
          # Set output for GitHub Actions summary
          echo "## Workflow Runs Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Total runs deleted:** $total_deleted" >> $GITHUB_STEP_SUMMARY
          echo "- **Total runs kept:** $total_kept" >> $GITHUB_STEP_SUMMARY
          echo "- **Retention period:** $RETENTION_DAYS days" >> $GITHUB_STEP_SUMMARY
          echo "- **Recent runs kept per workflow:** $KEEP_RECENT_RUNS" >> $GITHUB_STEP_SUMMARY
          echo "- **Cutoff date:** $CUTOFF_DATE" >> $GITHUB_STEP_SUMMARY
