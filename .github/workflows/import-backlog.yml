name: Import Stabilization Backlog

run-name: Import Stabilization Backlog (dry_run=${{ inputs.dry_run }})

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "If true, only print what would be created/imported"
        type: boolean
        required: false
        default: true

permissions:
  contents: read
  issues: write
  projects: write

jobs:
  import:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: ${{ secrets.PROJECT_ID }}
      PROJECT_NUMBER: ${{ secrets.PROJECT_NUMBER }}
      PARENT_FIELD_ID: ${{ secrets.PARENT_FIELD_ID }}
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        uses: cli/cli@v2
        with:
          version: latest

      - name: Load issues.json
        id: load
        run: |
          echo "json=$(cat automation/issues.json | jq -c .)" >> $GITHUB_OUTPUT

      - name: Import Issues
        run: |
          echo "Starting issue import..."
          echo "${{ steps.load.outputs.json }}" | jq -c '.[]' | while read issue; do
            TITLE=$(echo "$issue" | jq -r '.title')
            BODY=$(echo "$issue" | jq -r '.body')
            LABELS=$(echo "$issue" | jq -r '.labels | join(",")')

            # Check if issue already exists
            if gh issue list --search "$TITLE" --json title | jq -e ".[] | select(.title==\"$TITLE\")" > /dev/null; then
              echo "Skipping existing issue: $TITLE"
              continue
            fi

            if [ "${{ inputs.dry_run }}" = "true" ]; then
              echo "[DRY RUN] Would create issue: $TITLE"
            else
              echo "Creating issue: $TITLE"
              gh issue create \
                --title "$TITLE" \
                --body "$BODY" \
                --label "$LABELS"
            fi
          done

      - name: Import Project Structure (YAML)
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "[DRY RUN] Would import project YAML"
          else
            echo "Importing project YAML..."
            gh project item-import \
              --owner "${{ github.repository_owner }}" \
              --format yaml \
              --input automation/project-import.yml
          fi
