name: Release Changelog

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to generate changelog for (optional; defaults to current ref)"
        required: false
        type: string

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Set tag
        id: tag
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "value=${{ github.event.release.tag_name }}" >> "$GITHUB_OUTPUT"
          elif [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "value=${{ github.event.inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            # If manually run without specifying tag, assume current ref.
            echo "value=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate changelog (conventional commits)
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.tag.outputs.value }}"
          echo "Generating changelog for tag: $TAG"

          # Ensure tags exist locally (checkout fetch-depth:0 should already do this)
          git fetch --tags --force

          # Generate last release notes (most recent tag range)
          npx -y \
            -p conventional-changelog-cli@5.0.0 \
            -p conventional-changelog-conventionalcommits@8.0.0 \
            conventional-changelog \
            -p conventionalcommits \
            -r 1 \
            -o release-changelog.md

          # Generate full changelog as an artifact (does not modify repo files)
          npx -y \
            -p conventional-changelog-cli@5.0.0 \
            -p conventional-changelog-conventionalcommits@8.0.0 \
            conventional-changelog \
            -p conventionalcommits \
            -r 0 \
            -o CHANGELOG.generated.md

          echo "---- release-changelog.md ----"
          sed -n '1,120p' release-changelog.md || true

      - name: Upload changelog artifact
        uses: actions/upload-artifact@v4
        with:
          name: changelog-${{ steps.tag.outputs.value }}
          path: |
            release-changelog.md
            CHANGELOG.generated.md
          if-no-files-found: error
          retention-days: 14

      - name: Comment on associated PR (best-effort)
        if: github.event_name == 'release'
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG="${{ steps.tag.outputs.value }}"
          SHA=$(git rev-list -n 1 "$TAG")
          echo "Release tag $TAG points to $SHA"

          PR_NUMBER=$(gh api "repos/${GITHUB_REPOSITORY}/commits/$SHA/pulls" --jq '.[0].number // empty' || true)
          if [ -z "${PR_NUMBER:-}" ]; then
            echo "No associated PR found for commit $SHA; skipping PR comment."
            exit 0
          fi

          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          gh pr comment "$PR_NUMBER" --body "Release **$TAG** published.\n\nChangelog artifact: $RUN_URL (artifact name: changelog-$TAG)\n\n---\n\n$(cat release-changelog.md)"
