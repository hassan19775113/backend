{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }} | PraxiApp Admin{% endblock %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
    :root {
        --primary: #1A73E8;
        --success: #34A853;
        --warning: #FBBC05;
        --danger: #EA4335;
        --info: #00BCD4;
        --purple: #9C27B0;
        --dark: #202124;
        --light: #F8F9FA;
        --border: #E8EAED;
    }
    
    .dashboard-container {
        padding: 20px;
        background: var(--light);
        min-height: 100vh;
    }
    
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding: 20px 24px;
        background: linear-gradient(135deg, #1A73E8 0%, #9C27B0 100%);
        border-radius: 12px;
        color: white;
    }
    
    .dashboard-header h1 {
        margin: 0;
        font-size: 28px;
        font-weight: 600;
    }
    
    .dashboard-header .subtitle {
        opacity: 0.9;
        font-size: 14px;
        margin-top: 4px;
    }
    
    .header-actions {
        display: flex;
        gap: 12px;
    }
    
    .btn {
        background: rgba(255,255,255,0.2);
        color: white;
        border: 1px solid rgba(255,255,255,0.3);
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        text-decoration: none;
    }
    
    .btn:hover {
        background: rgba(255,255,255,0.3);
    }
    
    .btn-primary {
        background: white;
        color: var(--primary);
    }
    
    /* Section Headers */
    .section-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 32px 0 16px 0;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--border);
    }
    
    .section-header h2 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: var(--dark);
    }
    
    .section-header .badge {
        background: var(--primary);
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }
    
    /* KPI Cards Grid */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }
    
    .kpi-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
    }
    
    .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: var(--primary);
    }
    
    .kpi-card.success::before { background: var(--success); }
    .kpi-card.warning::before { background: var(--warning); }
    .kpi-card.danger::before { background: var(--danger); }
    .kpi-card.info::before { background: var(--info); }
    .kpi-card.purple::before { background: var(--purple); }
    
    .kpi-card .icon {
        font-size: 28px;
        margin-bottom: 8px;
    }
    
    .kpi-card .value {
        font-size: 32px;
        font-weight: 700;
        color: var(--dark);
        line-height: 1.2;
    }
    
    .kpi-card .title {
        font-size: 13px;
        color: #5F6368;
        margin-top: 4px;
        font-weight: 500;
    }
    
    .kpi-card .subtitle {
        font-size: 12px;
        color: #9AA0A6;
        margin-top: 4px;
    }
    
    .kpi-card .trend {
        display: inline-flex;
        align-items: center;
        font-size: 12px;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 12px;
        margin-top: 8px;
    }
    
    .trend.up { background: #E6F4EA; color: #137333; }
    .trend.down { background: #FCE8E6; color: #C5221F; }
    .trend.neutral { background: #E8EAED; color: #5F6368; }
    
    /* Efficiency Score Card */
    .efficiency-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .efficiency-score {
        font-size: 64px;
        font-weight: 700;
        line-height: 1;
    }
    
    .efficiency-label {
        font-size: 14px;
        margin-top: 8px;
        font-weight: 600;
    }
    
    .efficiency-components {
        display: flex;
        justify-content: center;
        gap: 16px;
        margin-top: 16px;
        flex-wrap: wrap;
    }
    
    .efficiency-component {
        font-size: 11px;
        color: #5F6368;
        padding: 4px 8px;
        background: var(--light);
        border-radius: 4px;
    }
    
    /* Charts Grid */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 24px;
        margin-bottom: 24px;
    }
    
    @media (max-width: 1200px) {
        .charts-grid { grid-template-columns: 1fr; }
    }
    
    .chart-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .chart-card.full-width {
        grid-column: span 2;
    }
    
    @media (max-width: 1200px) {
        .chart-card.full-width { grid-column: span 1; }
    }
    
    .chart-card h3 {
        margin: 0 0 16px 0;
        font-size: 16px;
        font-weight: 600;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .chart-container {
        position: relative;
        height: 280px;
    }
    
    .chart-container.small {
        height: 200px;
    }
    
    /* Funnel */
    .funnel-container {
        padding: 20px;
    }
    
    .funnel-stage {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .funnel-bar {
        height: 40px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        color: white;
        font-weight: 600;
        transition: all 0.3s;
    }
    
    .funnel-label {
        width: 120px;
        font-size: 13px;
        font-weight: 500;
        color: var(--dark);
    }
    
    .funnel-count {
        font-size: 14px;
    }
    
    .funnel-rate {
        font-size: 11px;
        opacity: 0.9;
    }
    
    /* Heatmap */
    .heatmap-container {
        overflow-x: auto;
    }
    
    .heatmap-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
    }
    
    .heatmap-table th {
        padding: 6px;
        text-align: center;
        color: #5F6368;
        font-weight: 500;
    }
    
    .heatmap-table td {
        padding: 4px;
        text-align: center;
    }
    
    .heatmap-cell {
        width: 28px;
        height: 28px;
        border-radius: 4px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 600;
        color: white;
    }
    
    .heatmap-day {
        font-weight: 600;
        color: var(--dark);
        text-align: left;
        padding-right: 12px;
    }
    
    /* Utilization Bars */
    .utilization-list {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .utilization-item {
        display: flex;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--border);
    }
    
    .utilization-item:last-child {
        border-bottom: none;
    }
    
    .utilization-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
        color: white;
        margin-right: 12px;
    }
    
    .utilization-info {
        flex: 1;
    }
    
    .utilization-name {
        font-size: 14px;
        font-weight: 500;
        color: var(--dark);
    }
    
    .utilization-details {
        font-size: 12px;
        color: #9AA0A6;
    }
    
    .utilization-bar-container {
        width: 120px;
        margin-left: 12px;
    }
    
    .utilization-bar {
        height: 8px;
        background: var(--border);
        border-radius: 4px;
        overflow: hidden;
    }
    
    .utilization-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s;
    }
    
    .utilization-percent {
        font-size: 13px;
        font-weight: 600;
        text-align: right;
        margin-top: 4px;
    }
    
    /* Legend */
    .heatmap-legend {
        display: flex;
        justify-content: center;
        gap: 16px;
        margin-top: 16px;
        font-size: 11px;
        color: #5F6368;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 4px;
    }
    
    /* Stats Summary */
    .stats-row {
        display: flex;
        gap: 24px;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border);
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 24px;
        font-weight: 700;
    }
    
    .stat-label {
        font-size: 12px;
        color: #5F6368;
    }
    
    /* Last Updated */
    .last-updated {
        text-align: center;
        color: #9AA0A6;
        font-size: 12px;
        padding: 16px;
        margin-top: 24px;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <div>
            <h1>üìä Scheduling KPIs</h1>
            <div class="subtitle">Terminplanung, Auslastung und Effizienz</div>
        </div>
        <div class="header-actions">
            <a href="/praxiadmin/dashboard/" class="btn">‚Üê Haupt-Dashboard</a>
            <button class="btn btn-primary" onclick="location.reload()">üîÑ Aktualisieren</button>
        </div>
    </div>
    
    <!-- Section: Operative KPIs -->
    <div class="section-header">
        <h2>‚ö° Operative KPIs</h2>
        <span class="badge">Echtzeit</span>
    </div>
    
    <div class="kpi-grid">
        <!-- Slot Utilization -->
        <div class="kpi-card {% if kpis.slot_utilization.utilization_rate >= 70 %}success{% elif kpis.slot_utilization.utilization_rate >= 40 %}warning{% else %}danger{% endif %}">
            <div class="icon">üìä</div>
            <div class="value">{{ kpis.slot_utilization.utilization_rate }}%</div>
            <div class="title">Slot-Auslastung</div>
            <div class="subtitle">{{ kpis.slot_utilization.booked_slots }} / {{ kpis.slot_utilization.available_slots }} Slots</div>
            <div class="trend {% if kpis.slot_utilization.trend > 0 %}up{% elif kpis.slot_utilization.trend < 0 %}down{% else %}neutral{% endif %}">
                {% if kpis.slot_utilization.trend > 0 %}‚Üë{% elif kpis.slot_utilization.trend < 0 %}‚Üì{% else %}‚Üí{% endif %}
                {{ kpis.slot_utilization.trend|floatformat:1 }}%
            </div>
        </div>
        
        <!-- No-Show Rate -->
        <div class="kpi-card {% if kpis.no_show.no_show_rate <= 5 %}success{% elif kpis.no_show.no_show_rate <= 15 %}warning{% else %}danger{% endif %}">
            <div class="icon">üö´</div>
            <div class="value">{{ kpis.no_show.no_show_rate }}%</div>
            <div class="title">No-Show Rate</div>
            <div class="subtitle">{{ kpis.no_show.no_show_count }} nicht erschienen</div>
            <div class="trend {% if kpis.no_show.trend < 0 %}up{% elif kpis.no_show.trend > 0 %}down{% else %}neutral{% endif %}">
                {% if kpis.no_show.trend < 0 %}‚Üì{% elif kpis.no_show.trend > 0 %}‚Üë{% else %}‚Üí{% endif %}
                {{ kpis.no_show.trend|floatformat:1 }}%
            </div>
        </div>
        
        <!-- Cancellation Rate -->
        <div class="kpi-card {% if kpis.cancellation.cancellation_rate <= 10 %}success{% elif kpis.cancellation.cancellation_rate <= 25 %}warning{% else %}danger{% endif %}">
            <div class="icon">‚ùå</div>
            <div class="value">{{ kpis.cancellation.cancellation_rate }}%</div>
            <div class="title">Stornierungsrate</div>
            <div class="subtitle">{{ kpis.cancellation.cancelled_count }} storniert</div>
        </div>
        
        <!-- Average Lead Time -->
        <div class="kpi-card info">
            <div class="icon">‚è±Ô∏è</div>
            <div class="value">{{ kpis.lead_time.avg_lead_time_days }} Tage</div>
            <div class="title">√ò Vorlaufzeit</div>
            <div class="subtitle">{{ kpis.lead_time.same_day_rate }}% Same-Day</div>
        </div>
        
        <!-- Rebooking Rate -->
        <div class="kpi-card {% if kpis.rebooking.rebooking_rate <= 10 %}success{% elif kpis.rebooking.rebooking_rate <= 25 %}warning{% else %}danger{% endif %}">
            <div class="icon">üîÑ</div>
            <div class="value">{{ kpis.rebooking.rebooking_rate }}%</div>
            <div class="title">Umbuchungsrate</div>
            <div class="subtitle">{{ kpis.rebooking.rebooked_count }} umgebucht</div>
        </div>
        
        <!-- New Patient Conversion -->
        <div class="kpi-card purple">
            <div class="icon">üë§</div>
            <div class="value">{{ kpis.new_patient.new_patient_rate }}%</div>
            <div class="title">Neupatienten-Anteil</div>
            <div class="subtitle">{{ kpis.new_patient.new_patients }} neue Patienten</div>
        </div>
    </div>
    
    <!-- Section: Effizienz -->
    <div class="section-header">
        <h2>üéØ Scheduling-Effizienz</h2>
    </div>
    
    <div class="charts-grid">
        <!-- Efficiency Score -->
        <div class="efficiency-card">
            <div class="efficiency-score" style="color: {{ kpis.efficiency.rating_color }};">
                {{ kpis.efficiency.efficiency_score }}
            </div>
            <div class="efficiency-label" style="color: {{ kpis.efficiency.rating_color }};">
                {{ kpis.efficiency.rating_label }}
            </div>
            <div class="efficiency-components">
                <div class="efficiency-component">
                    üìä Auslastung: {{ kpis.efficiency.components.utilization }}%
                </div>
                <div class="efficiency-component">
                    üö´ No-Show Abzug: -{{ kpis.efficiency.components.no_show_penalty }}
                </div>
                <div class="efficiency-component">
                    ‚ùå Storno Abzug: -{{ kpis.efficiency.components.cancellation_penalty }}
                </div>
                <div class="efficiency-component">
                    üîÑ Umbuchung Abzug: -{{ kpis.efficiency.components.rebooking_penalty }}
                </div>
            </div>
        </div>
        
        <!-- Trend Chart -->
        <div class="chart-card">
            <h3>üìà Erfolgsraten (12 Wochen)</h3>
            <div class="chart-container">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Section: Conversion Funnel -->
    <div class="section-header">
        <h2>üîÑ Termin-Funnel</h2>
    </div>
    
    <div class="charts-grid">
        <div class="chart-card">
            <h3>üìä Conversion Funnel</h3>
            <div class="funnel-container" id="funnelContainer"></div>
            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-value" style="color: var(--primary);">{{ kpis.new_patient.total_appointments }}</div>
                    <div class="stat-label">Gebucht</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: var(--success);">{{ kpis.cancellation.total_appointments|add:"-"|add:kpis.cancellation.cancelled_count }}</div>
                    <div class="stat-label">Best√§tigt</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: var(--danger);">{{ kpis.cancellation.cancelled_count }}</div>
                    <div class="stat-label">Storniert</div>
                </div>
            </div>
        </div>
        
        <!-- Lead Time Distribution -->
        <div class="chart-card">
            <h3>‚è±Ô∏è Vorlaufzeit-Verteilung</h3>
            <div class="chart-container">
                <canvas id="leadTimeChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Section: Auslastung -->
    <div class="section-header">
        <h2>üë• Kapazit√§tsauslastung</h2>
    </div>
    
    <div class="charts-grid">
        <!-- Doctor Utilization -->
        <div class="chart-card">
            <h3>üë®‚Äç‚öïÔ∏è Behandler-Auslastung</h3>
            <div class="utilization-list">
                {% for doc in kpis.doctor_utilization %}
                <div class="utilization-item">
                    <div class="utilization-avatar" style="background: {{ doc.color }};">
                        {{ doc.name|slice:":2"|upper }}
                    </div>
                    <div class="utilization-info">
                        <div class="utilization-name">{{ doc.name }}</div>
                        <div class="utilization-details">{{ doc.appointments }} Termine ‚Ä¢ {{ doc.booked_mins|floatformat:0 }} min</div>
                    </div>
                    <div class="utilization-bar-container">
                        <div class="utilization-bar">
                            <div class="utilization-fill" style="width: {{ doc.utilization }}%; background: {{ doc.color }};"></div>
                        </div>
                        <div class="utilization-percent" style="color: {{ doc.color }};">{{ doc.utilization }}%</div>
                    </div>
                </div>
                {% empty %}
                <p style="color: #9AA0A6; text-align: center; padding: 20px;">Keine √Ñrzte konfiguriert</p>
                {% endfor %}
            </div>
        </div>
        
        <!-- Room Utilization -->
        <div class="chart-card">
            <h3>üö™ Raum-Auslastung</h3>
            <div class="utilization-list">
                {% for room in kpis.room_utilization %}
                <div class="utilization-item">
                    <div class="utilization-avatar" style="background: {{ room.color }};">
                        üö™
                    </div>
                    <div class="utilization-info">
                        <div class="utilization-name">{{ room.name }}</div>
                        <div class="utilization-details">{{ room.appointments }} Buchungen ‚Ä¢ {{ room.booked_mins|floatformat:0 }} min</div>
                    </div>
                    <div class="utilization-bar-container">
                        <div class="utilization-bar">
                            <div class="utilization-fill" style="width: {{ room.utilization }}%; background: {{ room.color }};"></div>
                        </div>
                        <div class="utilization-percent" style="color: {{ room.color }};">{{ room.utilization }}%</div>
                    </div>
                </div>
                {% empty %}
                <p style="color: #9AA0A6; text-align: center; padding: 20px;">Keine R√§ume konfiguriert</p>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Section: Peak Load -->
    <div class="section-header">
        <h2>üî• Peak-Load Analyse</h2>
    </div>
    
    <div class="charts-grid">
        <!-- Hourly Load -->
        <div class="chart-card">
            <h3>üïê Termine pro Stunde</h3>
            <div class="chart-container small">
                <canvas id="hourlyChart"></canvas>
            </div>
        </div>
        
        <!-- Weekday Load -->
        <div class="chart-card">
            <h3>üìÖ Termine pro Wochentag</h3>
            <div class="chart-container small">
                <canvas id="weekdayChart"></canvas>
            </div>
        </div>
        
        <!-- Heatmap -->
        <div class="chart-card full-width">
            <h3>üóìÔ∏è Auslastungs-Heatmap (Stunde √ó Wochentag)</h3>
            <div class="heatmap-container">
                <table class="heatmap-table">
                    <thead>
                        <tr>
                            <th></th>
                            <th>07</th><th>08</th><th>09</th><th>10</th><th>11</th><th>12</th>
                            <th>13</th><th>14</th><th>15</th><th>16</th><th>17</th><th>18</th><th>19</th>
                        </tr>
                    </thead>
                    <tbody id="heatmapBody"></tbody>
                </table>
            </div>
            <div class="heatmap-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #E8EAED;"></div>
                    <span>Keine</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: rgba(26, 115, 232, 0.3);"></div>
                    <span>Niedrig</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: rgba(26, 115, 232, 0.6);"></div>
                    <span>Mittel</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: rgba(26, 115, 232, 0.9);"></div>
                    <span>Hoch</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #EA4335;"></div>
                    <span>Peak</span>
                </div>
            </div>
            <p style="text-align: center; margin-top: 12px; color: #5F6368; font-size: 13px;">
                üî• Peak: <strong>{{ kpis.peak_load.peak_day }} um {{ kpis.peak_load.peak_hour }}:00 Uhr</strong> 
                ({{ kpis.peak_load.peak_count }} Termine)
            </p>
        </div>
    </div>
    
    <div class="last-updated">
        Zuletzt aktualisiert: {{ kpis.generated_at|slice:":19"|default:"Jetzt" }}
    </div>
</div>

<script>
    const chartsData = {{ charts_json|safe }};
    const heatmapMatrix = {{ heatmap_matrix|safe }};
    const funnelData = {{ funnel_data|safe }};
    
    // Chart.js defaults
    Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
    Chart.defaults.color = '#5F6368';
    
    // Trend Chart
    new Chart(document.getElementById('trendChart'), {
        type: 'line',
        data: chartsData.completion_rate_trend,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { boxWidth: 12 }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: { callback: v => v + '%' }
                }
            }
        }
    });
    
    // Lead Time Chart
    new Chart(document.getElementById('leadTimeChart'), {
        type: 'bar',
        data: chartsData.lead_time_distribution,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { precision: 0 } }
            }
        }
    });
    
    // Hourly Chart
    new Chart(document.getElementById('hourlyChart'), {
        type: 'bar',
        data: chartsData.hourly_load,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { precision: 0 } }
            }
        }
    });
    
    // Weekday Chart
    new Chart(document.getElementById('weekdayChart'), {
        type: 'bar',
        data: chartsData.weekday_load,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { precision: 0 } }
            }
        }
    });
    
    // Funnel
    const funnelContainer = document.getElementById('funnelContainer');
    const maxFunnel = funnelData.total || 1;
    
    funnelData.funnel.forEach((stage, idx) => {
        const width = Math.max(30, (stage.count / maxFunnel) * 100);
        const rate = idx > 0 
            ? Math.round((stage.count / funnelData.funnel[idx-1].count) * 100) 
            : 100;
        
        funnelContainer.innerHTML += `
            <div class="funnel-stage">
                <div class="funnel-label">${stage.stage}</div>
                <div class="funnel-bar" style="width: ${width}%; background: ${stage.color};">
                    <span class="funnel-count">${stage.count}</span>
                    <span class="funnel-rate">${rate}%</span>
                </div>
            </div>
        `;
    });
    
    // Heatmap
    const days = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
    const heatmapBody = document.getElementById('heatmapBody');
    const maxVal = Math.max(...heatmapMatrix.flat()) || 1;
    
    days.forEach((day, dayIdx) => {
        const row = document.createElement('tr');
        row.innerHTML = `<td class="heatmap-day">${day}</td>`;
        
        for (let hour = 7; hour <= 19; hour++) {
            const count = heatmapMatrix[dayIdx][hour] || 0;
            const intensity = count / maxVal;
            
            let color;
            if (count === 0) {
                color = '#E8EAED';
            } else if (intensity >= 0.9) {
                color = '#EA4335';
            } else if (intensity >= 0.6) {
                color = 'rgba(26, 115, 232, 0.9)';
            } else if (intensity >= 0.3) {
                color = 'rgba(26, 115, 232, 0.6)';
            } else {
                color = 'rgba(26, 115, 232, 0.3)';
            }
            
            row.innerHTML += `
                <td>
                    <div class="heatmap-cell" 
                         style="background: ${color}; color: ${count > 0 ? 'white' : '#9AA0A6'};" 
                         title="${day} ${hour}:00 - ${count} Termine">
                        ${count > 0 ? count : ''}
                    </div>
                </td>
            `;
        }
        
        heatmapBody.appendChild(row);
    });
</script>
{% endblock %}
